const{Client:Client,EmbedBuilder:EmbedBuilder,GatewayIntentBits:GatewayIntentBits,ActionRowBuilder:ActionRowBuilder,ButtonStyle:ButtonStyle,ButtonBuilder:ButtonBuilder}=require("discord.js"),fs=require("fs"),path=require("path"),colors=require("colors"),{token:token,ownerID:ownerID,rateLimitDelay:rateLimitDelay,prefix:prefix}=require("./config.json"),client=new Client({intents:[GatewayIntentBits.Guilds,GatewayIntentBits.GuildMembers,GatewayIntentBits.DirectMessages,GatewayIntentBits.GuildMessages,GatewayIntentBits.MessageContent]});let successLog=[],failLog=[],rateLimitDelayy=rateLimitDelay;const Grup_Batch=10,handleRateLimit=async(e,t=3)=>{for(let l=1;l<=t;l++)try{return await new Promise((e=>setTimeout(e,rateLimitDelayy))),await e()}catch(e){if(!e.message.includes("rate limit"))throw 50007===e.code?new Error("DM Kapalı"):e;console.log(`Rate limit algılandı. ${l}. deneme yapılıyor...`),rateLimitDelayy+=500}throw new Error("Rate limit denemeleri başarısız oldu.")};client.once("ready",(()=>{function e(e,t){const l=[...e].length,a=Math.max(0,Math.floor((t-2-l)/2));return" ".repeat(a)+e+" ".repeat(t-2-l-a)}!async function(t){const l=t.user?.tag||"MNG Airlines Bot",a=t.guilds?.cache?.size||0,n=t.guilds?.cache?.reduce(((e,t)=>e+t.memberCount),0)||0,o=process.stdout.columns||80,i=Math.min(36,Math.floor(o/2)-2),r=new Date,s=`${r.getDate().toString().padStart(2,"0")}.${(r.getMonth()+1).toString().padStart(2,"0")}.${r.getFullYear()} - ${r.getHours().toString().padStart(2,"0")}:${r.getMinutes().toString().padStart(2,"0")}`,d=["╔".blue.bold+"═".repeat(i-2).blue.bold+"╗".blue.bold,"║".blue.bold+" ".repeat(i-2).blue.bold+"║".blue.bold,"║".blue.bold+e("MNG Airlines DM Duyuru ✈️",i).white.bold+"║".blue.bold,"║".blue.bold+e(s,i).white.bold+"║".blue.bold,"║".blue.bold+" ".repeat(i-2).blue.bold+"║".blue.bold,"║".blue.bold+" ".repeat(i-2).blue.bold+"║".blue.bold,"╚".blue.bold+"═".repeat(i-2).blue.bold+"╝".blue.bold],u=["╔".magenta.bold+"═".repeat(i-2).magenta.bold+"╗".magenta.bold,"║".magenta.bold+" ".repeat(i-2).magenta.bold+"║".magenta.bold,"║".magenta.bold+e(`Bot: ${l}`,i).cyan.bold+"║".magenta.bold,"║".magenta.bold+e(`Sunucular: ${a}`,i).yellow.bold+"║".magenta.bold,"║".magenta.bold+e(`Kullanıcılar: ${n}`,i).green.bold+"║".magenta.bold,"║".magenta.bold+" ".repeat(i-2).magenta.bold+"║".magenta.bold,"╚".magenta.bold+"═".repeat(i-2).magenta.bold+"╝".magenta.bold],m=Math.max(d.length,u.length);for(let e=0;e<m;e++){const t=e<d.length?d[e]:" ".repeat(i),l=e<u.length?u[e]:" ".repeat(i);console.log(t+"  "+l)}}(client);const t=72,l="MNG Airlines | DM Duyuru";console.log("╔".yellow.bold+"═".repeat(t).yellow.bold+"╗".yellow.bold);const a=Math.floor(24);console.log("║".yellow.bold+" ".repeat(a)+l.magenta.bold+" ".repeat(48-a)+"║".yellow.bold),console.log("║".yellow.bold+" ".repeat(t)+"║".yellow.bold);const n="daha fazla proje yada satın alım / bot yaptırma için discord sunucumuza gelin https://discord.gg/h7YAermnyw".split(" ");let o="";for(const e of n)if(o.length+e.length+1<=t)o+=(o?" ":"")+e;else{const l=Math.floor((t-o.length)/2);console.log("║".yellow.bold+" ".repeat(l)+o.white.bold+" ".repeat(t-o.length-l)+"║".yellow.bold),o=e}if(o){const e=Math.floor((t-o.length)/2);console.log("║".yellow.bold+" ".repeat(e)+o.white.bold+" ".repeat(t-o.length-e)+"║".yellow.bold)}console.log("╚".yellow.bold+"═".repeat(t).yellow.bold+"╝".yellow.bold)})),client.on("messageCreate",(async e=>{if(!e.guild||e.author.bot)return;const t=e.content.split(/ +/),l=t.shift().toLowerCase();if(e.author.id===ownerID){if(l===`${prefix}dm`){const l=/^<@!?(\d+)>$/,a=e.mentions.users.first();if(!a||!l.test(t[0]))return e.reply(`❌ **HATA:** Geçerli bir kullanıcı etiketlemelisiniz!\nÖrnek: \`${prefix}dm @Kullanıcı Merhaba\``);const n=t.slice(1).join(" ").trim();if(!n)return e.reply("❌ **HATA:** Göndereceğiniz mesajı yazmalısınız!");try{return await a.send(n),e.reply(`✅ Mesaj sadece ${a} kullanıcısına iletildi!`)}catch(t){return e.reply(`❌ ${a} kullanıcısına mesaj iletilemedi! (DM'leri kapalı olabilir)`)}}if(l===`${prefix}dmherkes`){const l=t.join(" ").trim();if(!l)return e.reply({content:"❌ Göndermek istediğiniz mesajı yazmalısınız!"});const a=(await e.guild.members.fetch({cache:!0})).filter((e=>!e.user.bot)),n=a.size;let o=0,i=0,r=!1,s=0;const d=(new EmbedBuilder).setColor(5793266).setTitle("📢 TOPLU DM GÖNDERİMİ").setDescription([`**Hedef:** Tüm sunucu (${n} kişi)`,"**Durum:** Başlatılıyor...",`**İlerleme:** 0/${n} (0%)`,`**Kalan:** ${n} kişi`].join("\n")).addFields({name:"✅ Başarılı",value:"```0```",inline:!0},{name:"❌ Başarısız",value:"```0```",inline:!0}).setFooter({text:`${e.author.tag} | ${e.guild.name}`,iconURL:e.author.displayAvatarURL()}),u=(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("lweaxo_duyuru_bot").setDisabled(!0).setEmoji({name:"📢"}).setLabel("Toplu DM").setStyle(ButtonStyle.Secondary),(new ButtonBuilder).setCustomId("cancel_dm").setLabel("İptal Et").setStyle(ButtonStyle.Danger).setEmoji("✖️")),m=await e.channel.send({embeds:[d],components:[u]}),c=m.createMessageComponentCollector({filter:t=>t.user.id===e.author.id,time:36e5});c.on("collect",(async e=>{"cancel_dm"===e.customId&&(r=!0,s=Math.round((o+i)/n*100),await e.update({content:`❌ Gönderim iptal edildi! (Tamamlanan: ${s}%)`,components:[(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("lweaxo_duyuru_bot").setDisabled(!0).setEmoji({name:"📢"}).setLabel("Toplu DM").setStyle(ButtonStyle.Secondary),(new ButtonBuilder).setCustomId("cancel_dm").setDisabled(!0).setLabel("İptal Edildi").setStyle(ButtonStyle.Danger))]}),c.stop())}));const b=async()=>{s=Math.round((o+i)/n*100),d.setDescription([`**Hedef:** Tüm sunucu (${n} kişi)`,"**Durum:** "+(r?"İptal Edildi":"Devam Ediyor"),`**İlerleme:** ${o+i}/${n} (${s}%)`,`**Kalan:** ${n-(o+i)} kişi`].join("\n")),d.setFields({name:"✅ Başarılı",value:`\`\`\`${o.toString()}\`\`\``,inline:!0},{name:"❌ Başarısız",value:`\`\`\`${i.toString()}\`\`\``,inline:!0}),await m.edit({embeds:[d],components:[(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("lweaxo_duyuru_bot").setDisabled(!0).setEmoji({name:"📢"}).setLabel("Toplu DM").setStyle(ButtonStyle.Secondary),(new ButtonBuilder).setCustomId("cancel_dm").setLabel(r?"İptal Edildi":"İptal Et").setStyle(ButtonStyle.Danger).setDisabled(r).setEmoji("✖️"))]})},y=Array.from(a.values());for(let e=0;e<y.length&&!r;e++){try{await y[e].send(l),o++}catch(e){i++}e%10!=0&&e!==y.length-1||(await b(),r||e%40!=0||await new Promise((e=>setTimeout(e,rateLimitDelayy))))}r||(d.setTitle("✅ GÖNDERİM TAMAMLANDI").setColor(5763719).setDescription([`**Hedef:** Tüm sunucu (${n} kişi)`,"**Durum:** ✅ Tamamlandı",`**Tamamlanma:** ${s}%`,`**Süre:** ${Math.round((Date.now()-m.createdTimestamp)/1e3)} saniye`].join("\n")).setFields({name:"✅ Başarılı",value:`\`\`\`${o.toString()}\`\`\``,inline:!0},{name:"❌ Başarısız",value:`\`\`\`${i.toString()}\`\`\``,inline:!0}),await m.edit({embeds:[d],components:[(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("lweaxo_duyuru_bot").setDisabled(!0).setEmoji({name:"📢"}).setLabel("Toplu DM").setStyle(ButtonStyle.Secondary),(new ButtonBuilder).setCustomId("islem_tamam_mng_airlines").setLabel("İşlem Tamamlandı!").setEmoji("✅").setStyle(ButtonStyle.Secondary).setDisabled(!0))]}));const g=[`=== ${(new Date).toLocaleString("tr-TR")} ===`,`Yetkili: ${e.author.tag} (${e.author.id})`,`Sunucu: ${e.guild.name} (${e.guild.id})`,`Mesaj: "${l}"`,`Hedeflenen: ${n} kişi`,`Başarılı: ${o}`,`Başarısız: ${i}`,`Tamamlanma: ${s}%`,"Durum: "+(r?"İPTAL":"TAMAMLANDI"),`Süre: ${Math.round((Date.now()-m.createdTimestamp)/1e3)} sn`,"=== SON ===\n"].join("\n"),p=path.join(__dirname,"logs");fs.existsSync(p)||fs.mkdirSync(p,{recursive:!0});const w=path.join(p,`dm_${e.guild.id}_${Date.now()}.txt`);fs.writeFileSync(w,g)}if(l===`${prefix}yardım`){const t=(new EmbedBuilder).setDescription(`\n**${prefix}dm @etiket mesaj** → Sadece etiketlenen kişiye DM atar\n\n**${prefix}dmherkes mesaj** → Tüm sunucuya DM atar (botlar hariç)\n\n**${prefix}yardım** → Bu menüyü gösterir`).setColor("Purple").setTimestamp(),l=(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("mng_airlines_lweaxo").setDisabled(!0).setEmoji("📢").setLabel("Dm Duyuru").setStyle(ButtonStyle.Secondary));e.reply({embeds:[t],components:[l]})}}})),client.login(token);