const{Client:Client,EmbedBuilder:EmbedBuilder,GatewayIntentBits:GatewayIntentBits,ActionRowBuilder:ActionRowBuilder,ButtonStyle:ButtonStyle,ButtonBuilder:ButtonBuilder}=require("discord.js"),fs=require("fs"),path=require("path"),colors=require("colors"),{token:token,ownerID:ownerID}=require("./config.json"),client=new Client({intents:[GatewayIntentBits.Guilds,GatewayIntentBits.GuildMembers,GatewayIntentBits.DirectMessages,GatewayIntentBits.GuildMessages,GatewayIntentBits.MessageContent]});let successLog=[],failLog=[],rateLimitDelay=2500;const handleRateLimit=async(e,t=3)=>{for(let l=1;l<=t;l++)try{return await new Promise((e=>setTimeout(e,rateLimitDelay))),await e()}catch(e){if(!e.message.includes("rate limit"))throw 50007===e.code?new Error("DM Kapalı"):e;console.log(`Rate limit algılandı. ${l}. deneme yapılıyor...`),rateLimitDelay+=500}throw new Error("Rate limit denemeleri başarısız oldu.")};client.once("ready",(()=>{function e(e,t){const l=[...e].length,n=Math.max(0,Math.floor((t-2-l)/2));return" ".repeat(n)+e+" ".repeat(t-2-l-n)}!async function(t){const l=t.user?.tag||"MNG Airlines Bot",n=t.guilds?.cache?.size||0,o=t.guilds?.cache?.reduce(((e,t)=>e+t.memberCount),0)||0,a=process.stdout.columns||80,i=Math.min(36,Math.floor(a/2)-2),s=new Date,r=`${s.getDate().toString().padStart(2,"0")}.${(s.getMonth()+1).toString().padStart(2,"0")}.${s.getFullYear()} - ${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`,d=["╔".blue.bold+"═".repeat(i-2).blue.bold+"╗".blue.bold,"║".blue.bold+" ".repeat(i-2).blue.bold+"║".blue.bold,"║".blue.bold+e("MNG Airlines DM Duyuru ✈️",i).white.bold+"║".blue.bold,"║".blue.bold+e(r,i).white.bold+"║".blue.bold,"║".blue.bold+" ".repeat(i-2).blue.bold+"║".blue.bold,"║".blue.bold+" ".repeat(i-2).blue.bold+"║".blue.bold,"╚".blue.bold+"═".repeat(i-2).blue.bold+"╝".blue.bold],u=["╔".magenta.bold+"═".repeat(i-2).magenta.bold+"╗".magenta.bold,"║".magenta.bold+" ".repeat(i-2).magenta.bold+"║".magenta.bold,"║".magenta.bold+e(`Bot: ${l}`,i).cyan.bold+"║".magenta.bold,"║".magenta.bold+e(`Sunucular: ${n}`,i).yellow.bold+"║".magenta.bold,"║".magenta.bold+e(`Kullanıcılar: ${o}`,i).green.bold+"║".magenta.bold,"║".magenta.bold+" ".repeat(i-2).magenta.bold+"║".magenta.bold,"╚".magenta.bold+"═".repeat(i-2).magenta.bold+"╝".magenta.bold],m=Math.max(d.length,u.length);for(let e=0;e<m;e++){const t=e<d.length?d[e]:" ".repeat(i),l=e<u.length?u[e]:" ".repeat(i);console.log(t+"  "+l)}}(client);const t=72,l="MNG Airlines | DM Duyuru";console.log("╔".yellow.bold+"═".repeat(t).yellow.bold+"╗".yellow.bold);const n=Math.floor(24);console.log("║".yellow.bold+" ".repeat(n)+l.magenta.bold+" ".repeat(48-n)+"║".yellow.bold),console.log("║".yellow.bold+" ".repeat(t)+"║".yellow.bold);const o="daha fazla proje yada satın alım / bot yaptırma için discord sunucumuza gelin https://discord.gg/h7YAermnyw".split(" ");let a="";for(const e of o)if(a.length+e.length+1<=t)a+=(a?" ":"")+e;else{const l=Math.floor((t-a.length)/2);console.log("║".yellow.bold+" ".repeat(l)+a.white.bold+" ".repeat(t-a.length-l)+"║".yellow.bold),a=e}if(a){const e=Math.floor((t-a.length)/2);console.log("║".yellow.bold+" ".repeat(e)+a.white.bold+" ".repeat(t-a.length-e)+"║".yellow.bold)}console.log("╚".yellow.bold+"═".repeat(t).yellow.bold+"╝".yellow.bold)})),client.on("messageCreate",(async e=>{if(!e.guild||e.author.bot)return;const t=e.content.split(" "),l=t.shift().toLowerCase();if(e.author.id!==ownerID&&l.startsWith("!"))return e.reply("Bu komutu kullanma yetkiniz yok!");if("!dm"===l||"!dmherkes"===l){const n="!dm"===l?t.filter((e=>isNaN(e)&&!e.startsWith("<@"))).join(" "):t.join(" ");if(!n)return e.reply({content:"❌ Göndermek istediğiniz mesajı yazmalısınız!"});const o=await e.guild.members.fetch({cache:!0}),a=o.filter((e=>!e.user.bot)).size;let i=[],s=[],r=Math.min(parseInt(t.find((e=>!isNaN(e))),10)||a,a),d=0,u=!1;const m=(new EmbedBuilder).setColor(16753920).setTitle("📨 Toplu DM Gönderimi").setDescription(["**Durum:** Başlatılıyor...",`**İlerleme:** 0/${r} (0%)`,`**Kalan:** ${r} kişi`].join("\n")).addFields({name:"✅ Başarılı",value:"0",inline:!0},{name:"❌ Başarısız",value:"0",inline:!0}).setFooter({text:`${e.author.tag} | ${e.guild.name}`,iconURL:e.author.displayAvatarURL()}).setTimestamp(),c=(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("lweaxo_duyuru_bot").setDisabled(!0).setEmoji({name:"📢"}).setLabel("Dm Duyuru").setStyle(ButtonStyle.Secondary),(new ButtonBuilder).setCustomId("cancel_dm").setEmoji({name:"❌"}).setLabel("İptal").setStyle(ButtonStyle.Danger)),b=await e.channel.send({embeds:[m],components:[c]}),g=t=>"cancel_dm"===t.customId&&t.user.id===e.author.id,y=b.createMessageComponentCollector({filter:g,time:36e5});y.on("collect",(async e=>{u=!0,await e.update({content:"❌ DM gönderimi iptal edildi!",components:[(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("lweaxo_duyuru_bot").setDisabled(!0).setEmoji({name:"📢"}).setLabel("Dm Duyuru").setStyle(ButtonStyle.Secondary),(new ButtonBuilder).setCustomId("cancel_dm").setEmoji({name:"❌"}).setDisabled(!0).setLabel("İptal").setStyle(ButtonStyle.Danger))]}),y.stop()}));const p=async(e=!1)=>{const t=Math.round(d/r*100),l=r-d;m.setDescription([`**Durum:** ${e?"Tamamlandı":u?"İptal Edildi":"Devam ediyor"}...`,`**İlerleme:** ${d}/${r} (${t}%)`,`**Kalan:** ${e?"0":l} kişi`].join("\n")),m.setFields({name:"✅ Başarılı",value:i.length.toString(),inline:!0},{name:"❌ Başarısız",value:s.length.toString(),inline:!0}),(e||u)&&m.setColor(u?16711680:0===s.length?65280:s.length===r?16711680:16753920),await b.edit({embeds:[m],components:[(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("lweaxo_duyuru_bot").setDisabled(!0).setEmoji({name:"📢"}).setLabel("Dm Duyuru").setStyle(ButtonStyle.Secondary),(new ButtonBuilder).setCustomId("cancel_dm").setEmoji({name:"❌"}).setDisabled(!0).setLabel("İptal").setStyle(ButtonStyle.Danger))]})},w=10,h=3e3,B=o.filter((e=>!e.user.bot)).first(r);for(let e=0;e<B.length&&!u;e++){const t=B[e];try{if(e>0&&e%w==0&&(await p(),await new Promise((e=>setTimeout(e,h))),u))break;await t.send({content:n}),i.push(t.user.tag),d++}catch(e){const l=50007===e.code?"DM Kapalı":e.message.includes("rate limited")?"Rate Limit":e.message.slice(0,50);s.push(`${t.user.tag} (${l})`)}(e%5==0||e===B.length-1||u)&&await p(e===B.length-1||u)}const D=[`=== ${(new Date).toLocaleString()} ===`,`Komutu Kullanan: ${e.author.tag} (${e.author.id})`,`Sunucu: ${e.guild.name} (${e.guild.id})`,`Gönderilen Mesaj: "${n.slice(0,50)}${n.length>50?"...":""}"`,`Toplam: ${r} kişi`,`Başarılı: ${i.length}`,`Başarısız: ${s.length}`,"İptal Edildi: "+(u?"Evet":"Hayır"),`\nBAŞARILI KULLANICILAR:\n${i.join("\n")}`,`\nBAŞARISIZ KULLANICILAR:\n${s.join("\n")}`,"\n=== SON ===\n"].join("\n"),S=`dm_logs_${(new Date).toISOString().split("T")[0]}.txt`,f=path.join(__dirname,"logs",S);fs.mkdirSync(path.dirname(f),{recursive:!0}),fs.appendFileSync(f,D)}if("!yardım"===l){if(e.author.id!==ownerID&&l.startsWith("!"))return e.reply("Bu komutu kullanma yetkiniz yok!");const t=(new EmbedBuilder).setDescription("\n**!dm <@etiket> <mesaj>** **__|__** `Seçili kişiye dm mesajı gönderir.`\n**!dmherkes <mesaj>** **__|__** `Sunucudaki herkese dm mesajı gönderir.`\n**!yardım** **__|__** `komutları gösterir.`").setColor("Purple").setTimestamp(),n=(new ActionRowBuilder).addComponents((new ButtonBuilder).setCustomId("mng_airlines_lweaxo").setDisabled(!0).setEmoji({name:"📢"}).setLabel("Dm Duyuru").setStyle(ButtonStyle.Secondary));e.reply({embeds:[t],components:[n]})}})),client.login(token);